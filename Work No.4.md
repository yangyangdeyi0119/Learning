# Work No.4

### 一、3D打印机编程

- #### 学习资料

  - [[G-Codes - Klipper 文档 (klipper3d.org)](https://www.klipper3d.org/zh/G-Codes.html)](https://www.klipper3d.org/zh/Overview.html)
  - [G-code - RepRap](https://reprap.org/wiki/G-code)
  - [3D 打印机 G 代码命令：完整列表和教程_3d打印机g代码-CSDN博客](https://blog.csdn.net/acktomas/article/details/125552309)
  - [3D打印机DIY之六------G代码命令_g代码m300-CSDN博客](https://blog.csdn.net/qlexcel/article/details/103466638)

- #### G指令

  - **G0/G1: 直线移动**
    -  G0和G1命令完全等价，作用就是让喷头线性移动到一个特定的位置，使用时，不需要所有的参数全部存在，但至少要有一个参数。
    - G0 Xnnn Ynnn Znnn Ennn Fnnn Snnn / G1 Xnnn Ynnn Znnn Ennn Fnnn Snnn
      - Xnnn表示X轴的移动位置；
      - Ynnn表示Y轴的移动位置；
      - Znnn表示Z轴的移动位置；
      - Ennn表示E轴（挤出头步进电机）的移动位置；
      - Fnnn表示移动速度，单位是毫米/每分钟；
      - Snnn表示是否检查限位开关，S0不检查，S1检查，缺省值是S0；
  - **G28：复位**
    - 打印机复位命令。执行时会让3个轴依次往限位开关的方向运行，碰到限位开关后还会减速做一次1mm左右的往返运动，来保证复位的准确性。如果在命令后面加上坐标值，则只会复位坐标值对应的坐标轴。（坐标值的数字会被忽略）
    - G28 X0 Y72.3
      - 只会复位x轴和y轴。
  - **G29：Z轴高度三点测试**
    - 这条命令会测试打印平面上三个点的Z轴高度，并在串口上输出结果。参数为Snnn，表示对测试结果的处理方式。S1表示更新内存中的Z轴高度值（重置系统会丢失），S2表示更新内存以及EEPROM中的Z轴高度值（重置系统不会丢失）。
    - 一般来说，只有使用高位限位开关（也就是说，Z轴的限位开关位于Z轴坐标最大处），且在挤出头上附带有Z轴高度测试微动开关的机型，适合使用G29命令测试Z轴高度。其他机械配置的机型，不适合使用G29命令。G29命令由固件配置
  - **G30：Z轴高度单点测试（单步）**
    - 这条命令作为一个完整Z轴高度测试过程的一步，测试打印平面上一个点的Z轴高度，并在串口上输出结果。这个完整的Z轴高度测试过程，通常是由3D打印机控制软件连续发出的，通过参数控制G30的执行状态。因此在手动工作方式下，G30命令只适合不带参数运行
  - **G31：输出Z轴高度测试微动开关状态**
    - 执行后会输出当前Z轴高度测试微动开关的当前状态，其中L表示微动开关没有触发。如果是处于触发状态，这里会输出H。
    - G29命令、G30命令、G31命令只进行Z轴的高度测试，并不进行自动调平。
  - **G32：热床自动调平**
    - 这条命令在G29命令的基础上，不仅测试打印平面上三个点的Z轴高度，而且还会根据测试的结果，对3D打印机的机械参数进行调整，实现热床自动调平。G32命令使用的参数与G29命令是一致的：Snnn，表示测试结果的处理方式。S1表示更新内存中的相关参数值（重置系统会丢失），S2表示更新内存以及EEPROM中的相关参数值（重置系统不会丢失）。
    - G32命令执行完成时，不仅Z轴高度参数发生了改变，而且还会根据3D打印机的硬件配置，对热床进行相应的调平处理。
    - G32命令会在3D打印机内存中构建一个转换矩阵（Transformation matrix），让未来3D打印机所处理的所有三维空间位置，都先经过这个矩阵的变换，保证在Z=0的情况下，正好与热床平面完全吻合
  - **G4: 暂停移动**
    - 让喷头在当前位置停留一段时间。参数可以为：G4 Pnnn或G4 Snnn。Pnnn表示以毫秒为单位，Snnn表示以秒为单位。
    - G4 P2000与G4 S2完全等价，都表示停顿2秒。
    - 在停顿过程中机器仍可以被控制，如挤出头温度。
  - **G20:使用英寸作为单位**
    - 执行这条命令后，后面的命令都以英寸作为单位。
  - **G21: 使用毫米作为单位**
    - 执行这条命令后，后面的命令都以毫米作为单位。
  - **G90/G91：设置坐标模式**
    - 这两条命令用于设置当前坐标模式为绝对坐标模式(G90)或者相对坐标模式(G91)。没有参数。未设置时缺省值是绝对坐标模式
  - **G92:设置当前位置为某个坐标值**
    - 把当前位置设定为某个坐标值，可以用来设置零点，如果参数为空表示把当前位置设置为所有轴的的零点。
      - 如：G92 X10 E90    ;表示把当前位置设置为x=10，喷头坐标=90
      - 再如：G92 E0       ；表示把当前喷头坐标设置为0
  - **G94/G95:进给速率单位**
    - 使用了G94指令之后，所有的进给都是以mm/min为单位，即F100指刀具每分钟移动100毫米（默认的）
    - 使用了G95指令之后，所有的进给都是以mm/r为单位，即F100指主轴每转一转，刀具移动100毫米
  - **G17/G18/G19：选择加工平面**
    - G17–XY平面；
    - G18–XZ平面；
    - G19–YZ平面；

- #### M指令

  - **M0:打印机停止**
    - 打印机会终止任何动作，然后关机。所有的电机和加热器都会被关掉，这个时候只能通过reset按钮来重启控制器。

  - **M1: 打印机休眠**
    - 打印机会终止任何动作，然后休眠。所有的马达和加热器都会被关掉，但是接收到G或M命令时，打印机可以被唤醒并进入工作状态。

  - **M17:启动所有步进电机**
  - **M18:关闭所有步进电机**

  - **M20:读取SD卡根目录中的文件**

    - 读取SD卡根目录的文件，并通过串口输出文件名。

  - **M21:初始化SD卡**

    - 初始化SD卡。如果在机器通电时插入SD卡，会默认初始化SD卡。开始其他SD卡功能时，SD卡一定要先初始化。本命令相当于文件系统中执行Mount动作。

  - **M22:卸载SD卡**

    - 卸载SD卡，也就是执行Unmount动作。没有相关的参数。

  - **M23:选择SD卡中的文件**

    - 选择一个SD卡上的文件。文件选择之后，可以执行打印、删除等动作。
    - 如：M23 filename.gcode   ;选中filename.gcode文件

  - **M24:开始打印SD卡中选中的文件**

    - 开始打印通过M23命令选中的文件。

  - **M25:暂停SD卡打印**

    - 暂停打印通过M23命令选定的文件。

  - **M27:报告SD卡打印进度**

    - 获取SD卡打印进度。没有相关参数。

    - M27命令的输出，格式为：SD printing byte 11518/1127578

    - 这条命令供上位机获取当前的3D打印进度信息，用于显示在电脑界面上。

  - **M28:开始往SD卡文件中写入数据**

    - 接收到此命令后，后续接收到的命令（除了M29）都会被当成数据写入该文件。

    - 命令后面会跟着文件名，如果文件不存在则会被创建，如果存在则会被覆盖。接收到这条命令后，后续接收到的命令都会被写入该文件中，直到接收到M29命令。如：M28 filename.gcode  

  - **M29:停止往SD卡文件中写入数据**

    - 接收到此命令后，后续接收到的命令要开始正常执行。

  - **M30:删除SD卡中的文件**

    - 如：M30 filename.gcode     ;删除filename.gcode文件

  - **M32：创建子目录**

    - 在SD卡上创建一个子目录。参数为：filename，表示待创建的子目录（包含目录名，以/分隔）；

  - **M82/M83：设置挤出头步进电机坐标模式**

    - 与G90/G91命令类似，这两条命令用于设置挤出头当前坐标模式为绝对坐标模式(M82)或者相对坐标模式(M83)。没有参数。未设置时缺省值是绝对坐标模式。需要注意的是，G90/G91设置的坐标模式，同时对XYZE四个轴起作用，但M82/M83设置的坐标模式，只对E轴（挤出头步进电机）起作用。

  - **M84：设置步进电机自动关闭时间**

    - 当3D打印机一段时间没有接收到步进电机运动指令之后，3D打印机（为了节能）会自动关闭步进电机。使用M84指令，可以设置这个自动关闭步进电机的时间。
      - Snnn，表示步进电机关闭的时间，以秒为单位。
    - 如果使用M85时没有指定S参数，或者使用了S0参数，则代表取消3D打印机自动关闭功能，挤出头、热床等在工作完成之后，一直会处于当前状态，而不会被自动关闭。

  - **M73：获取当前打印进度**

    - 告诉固件当前的构建进度百分比。预计这台机器会在显示屏上显示出来。如果百分比恰好为0，则向主机发送“构建开始”通知。如果百分比恰好为100，则向主机发送“构建结束”通知。

  - **M105: 获取当前温度（单位：℃）**

    - 获取当前温度值，包括挤出头和热床的温度。
      - X，表示输出ADC测量的原始值；
    - M105命令的输出，格式为：T:18.97 /0 B:18.75 /0 B@:0 @:0
      - T:之后的部分，代表挤出头的当前温度/目标温度；
      - B:之后的部分代表热床的当前温度/目标温度。
    - 在PID温度控制模式下，B@:后面的数字代表热床当前的输出强度，是一个0~255的值，@:后面的数字，代表挤出头当前的输出强度，也是一个0~255的值。例子中，挤出头、热床都处于关闭状态，所以这个位置的值都是0。

  - **M104:设置挤出机（喷头）温度**

    - 设置挤出头的目标温度。执行这条命令后，不需要等待达到这个温度，控制板继续执行下一条G-code语句。
      - Snnn，表示目标温度；
      - Tnnn，表示对应的挤出头；
      - P，表示要等待前面的指令完成之后，再开始设置挤出头温度；
      - Fnnn，表示到达目标温度之后，是否触发蜂鸣器。F1表示要触发；
    - 如果执行命令时没有带T参数，则针对当前挤出头设置目标温度。
      - 如：M104 S190         ;将挤出机的温度设置为190度 

  - **M106: 打开风扇**

    - 如：M106 S127    ;打开风扇（半速）。
      - 'S'表示 PWM值 (0-255). 可简单理解为：风扇有0-255级强度可选，其中 M106 S0 意味着风扇将被关掉。
      - P表示风扇的数目，P0是第一个风扇，P1是第二个风扇

  - **M109: 等待挤出头加热达到目标温度**

    - 设置挤出头的目标温度，并等待达到这个温度。
      - Snnn，表示目标温度；
      - Tnnn，表示对应的挤出头；
      - Fnnn，表示到达目标温度之后，是否触发蜂鸣器。
      - F1表示要触发；
    - 如果执行命令时没有带T参数，则针对当前挤出头设置目标温度。如： M109 S185      ;等待挤出头加热到185度

  - **M114: 获取挤出头当前位置**

    - 输出挤出头当前位置。没有相关的参数。
    - M114命令的输出，格式为：
    - M114 X:20.00 Y:30.00 Z:10.000 E:0.0000

  - **M115: 获取3D打印机信息**

    - 输出3D打印机信息。没有相关的参数。
    - M115命令的输出，格式为：FIRMWARE_NAME:Repetier_0.92.3FIRMWARE_URL:…Printedfilament:0.00mPrintingtime:0days0hours0minSpeedMultiply:100FlowMultiply:100
    - 第一行是固件的版本信息，很长，没有列完整。第二行是已经打印了多少米耗材，打印时间是几天几小时几分钟。第三行是速度系数，参考M220命令。第四行是流率系数，参考M221命令。

  - **M140 设置热床目标温度**

    - 设置热床的目标温度。执行这条命令后，不需要等待达到这个温度，立即开始执行下一条G-code语句。
      - Snnn表示目标温度；
      - Fnnn表示到达目标温度之后，是否触发蜂鸣器。
      - F1表示要触发；

  - **M141:设置构建平台的温度**

    - 可能用于特定的温控策略或多热床系统
    - M141 S60将加热床设置为60摄氏度

  - **M190: 等待热床加热达到目标温度**

    - 设置热床的目标温度，并等待达到这个温度。
      - Snnn，表示目标温度；
      - Fnnn，表示到达目标温度之后，是否触发蜂鸣器。
      - F1表示要触发；

  - **M204：设置PID参数**

    - 设置挤出头温度控制的PID参数，
      - Snnn表示对应的挤出头，无S参数表示使用当前挤出头；
      - Xnnn表示P参数；
      - Ynnn表示I参数；
      - Znnn表示D参数；

  - **M220：设置速度**

    - 设置3D打印机运行速度系数。
    - 命令参数为Snnn表示系数，是一个百分数，如果S参数不存在，则使用缺省值100；
    - 3D打印机运行速度系数，是一个在25%到500%范围内变化的值。这个系数值在3D打印机运行过程中，与切片器给出的3D打印机运动速度基础值相乘，得到最终的3D打印机实际运动速度值。
    - M220命令的输出，格式为：SpeedMultiply:100

  - **M221：设置流率**

    - 设置3D打印机的流率系数（Flow rate）。
    - 命令参数为：Snnn表示系数，是一个百分数，如果S参数不存在，则使用缺省值100；
    - 3D打印机流率系数，是在上位机切片软件通过耗材直径、喷头直径、层高以及3D打印速度等因素综合计算得到的E轴运动速度的基础上，叠加的一个E轴运动速度系数。简单地说，就是控制挤出头耗材挤出量的多少。这个系数可以在25%到500%范围内变化。
    - M221命令的输出，格式为：FlowMultiply:100

- #### T指令

  - **T0/T1/T2/T3 命令，选择不同的工具或挤出机**
    - T0 选择第一个挤出机；T1 选择第二个挤出机；T2 选择第三个挤出机；T3 选择第四个挤出机


- #### 节选注释

```
M106 P2 S204    //打开第三个风扇，PWM值为204
;LAYER_CHANGE
;Z:16.8
;HEIGHT:0.199999
;BEFORE_LAYER_CHANGE
;16.8
G92 E0    //设置喷头当前位置为零点
M106 P2 S0    //关闭第二个风扇

G1 E-.35 F2400  //挤出机回抽挤出0.35mm，速度设置为2400mm/min
;WIPE_START
G1 F9473.877    //速度设置为9473.877mm/min
G1 X320.911 Y304.914 E-.11658    //直线插补，移动到（320.911，304.914）位置，并回抽0.11658
G1 X321.066 Y304.753 E-.03342    //直线插补，移动到（321.066，304.753）位置，并回抽0.03342
;WIPE_END
EXCLUDE_OBJECT_END NAME=ksr_fdmtest_w4.stl_id_0_copy_0
;_SET_FAN_SPEED_CHANGING_LAYER
EXCLUDE_OBJECT_START NAME=ksr_fdmtest_w4.stl_id_0_copy_0
G17    //选择XY平面
G3 Z17 I.035 J-1.216 P1  F30000    //圆弧插补，Z轴位置为17mm，圆心坐标为（321.066+0.035，304.753-1.216）,P1表示为顺时针，速度为30000mm/min
G1 X43.587 Y296.746 Z17    //直线插补，移动到（321.066，304.753，17）位置
G1 Z16.8    //直线插补，移动到（321.066，304.753，16.8）位置
G1 E.5 F2400    //挤出机挤出0.5mm，速度设置为2400mm/min
```

### 二、CNC数控编程

- **学习资料**
  - [数控机床编程入门【G-code】 | 学习软件编程 (hubwiz.com)](http://blog.hubwiz.com/2021/06/26/g-code-tutorial/)

- **G00–快速定位**
  - G00命令以最大速度将机器从当前位置移动到指定的坐标。机器将同时移动所有轴，以便同时完成行程。 结果是直线移动到新的位置点。

- **G01–线性插值**
  - G01 命令指示机器以设定速度直线移动。我们用X、Y和Z值指定最终位置，用F值指定速度。 CNC控制器计算（插值）要经过的中间点的坐标，以获得直线。

- **G02–顺时针环形插值**
  - G02命令要求机器以圆形模式顺时针移动。它与 G01 命令的概念相同，在执行适当的加工过程时使用。除了 终点参数，在这里我们还需要定义旋转中心，或弧线起点与弧线中心点的距离。起点实际上是上一个命令的 终点或当前点。

- **G03–逆时针环形插值**
  - 与 G02 一样，G03 命令指示机器以圆形模式移动，区别在于G03是逆时针运动。所有其他功能和规则与 G02 命令相同。
- **G20/G21 – 单位选择**
  - G20 和 G21 命令定义 G-code单位，英寸或毫米。G20 = 英寸；G21 = 毫米
- **G17/G18/G18 – 工作面选择**
  - G17–XY平面；G18–XZ平面；G19–YZ平面
- **G28–返回home**
  - G28命令要求机器将移动到其参考点或home位置。为了避免碰撞，我们可以包括一个带有 X、Y 和 Z 参数的 中间点。该工具将在转到参考点之前通过该点。
- **G90/G91 – 定位模式**
  - 使用 G90 和 G91 命令，我们告诉机器如何解析坐标值。G90为绝对模式，G91为相对模式。
- **其他代码**

```
- M00–程序停止
- M02–程序结束
- M03–主轴打开–顺时针
- M04–主轴打开–逆时针
- M05–主轴停止
- M06–工具更改
- M08–启用Flood Colant
- M09–禁用Flood Colant
- M30 – 程序结束
- M104–启动挤出加热
- M109–等到挤出器到达T0
- M140–开始底板加热
- M190–等到底板到达T0
- M106–设置风扇速度
```

- **代码解释**

```
%
G21 G17 G90 F100                     //G21单位选择毫米，G17选择XY平面，G90选择绝对模式，F100代表转速
M03 S1000                            //主轴打开-顺时针，速度为1000转
G00 X5 Y5                 ; point B  //快速移动到（5，5）
G01 X5 Y5 Z-1             ; point B  //直线插补移动到（5，5，-1）
G01 X5 Y15 Z-1            ; point C  //直线插补移动到（5，15，-1）
G02 X9 Y19 Z-1 I4 J0      ; point D  //顺时针环形插补移动到（9，19，-1），圆心为（9，15）
G01 X23 Y19 Z-1           ; point E  //直线插补移动到（23，19，-1）
G01 X32 Y5 Z-1            ; point F  //直线插补移动到（32，5，-1）
G01 X21 Y5 Z-1            ; point G  //直线插补移动到（21，5，-1）
G01 X21 Y8 Z-1            ; point H  //直线插补移动到（21，8，-1）
G03 X19 Y10 Z-1 I-2 J0    ; point I  //逆时针环形插补移动到（19，10，-1），圆心为（19，8）
G01 X13 Y10 Z-1           ; point J  //直线插补移动到（13，10，-1）
G03 X11 Y8 Z-1 I0 J-2     ; point K  //逆时针环形插补移动到（11，8，-1），圆心为（13，8）
G01 X11 Y5 Z-1            ; point L  //直线插补移动到（11，5，-1）
G01 X5 Y5 Z-1             ; point B  //直线插补移动到（5，5，-1）
G01 X5 Y5 Z0                         //直线插补移动到（5，5，0）
G28  X0 Y0                           //返回零点（0，0，0）
M05                                  //关闭主轴
M30                                  //程序结束
%
```

### 

